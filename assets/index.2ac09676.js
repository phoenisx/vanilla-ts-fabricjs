var t,e,s,a,i,r,n,o,c,l,h,d=Object.defineProperty,g=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable,p=(t,e,s)=>e in t?d(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,f=(t,e,s)=>(p(t,"symbol"!=typeof e?e+"":e,s),s);!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const s of t)if("childList"===s.type)for(const t of s.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerpolicy&&(e.referrerPolicy=t.referrerpolicy),"use-credentials"===t.crossorigin?e.credentials="include":"anonymous"===t.crossorigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const b=()=>(""+[1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(t=>(+t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>+t/4).toString(16))),m={objectsPerPage:{},pageHistoryStack:{},redoUpdateStack:{},activePage:"",activeObject:null},y=t=>{if(m.activePage){m.pageHistoryStack[m.activePage].length>=100&&m.pageHistoryStack[m.activePage].shift();const e=t.toJSON(["id"]);m.pageHistoryStack[m.activePage].push(JSON.stringify(e)),(!m.redoUpdateStack[m.activePage]||m.redoUpdateStack[m.activePage].length>0)&&(m.redoUpdateStack[m.activePage]=[])}};const w=[["#876FC3","#694AB5"],["#D55D8D","#CA3570"],["#DE8854","#D66A29"],["#C7CC66","#B9C03F"],["#73BF8B","#50AF6E"],["#4980B6","#6D99C5"],["#72C074","#4EB151"]],S=()=>{const t=Math.floor(100*Math.random()%w.length);return w[t]};const P=document.querySelector("#app"),k=new fabric.Canvas(P.querySelector("canvas"));null==(t=P.querySelector("#createPage"))||t.addEventListener("click",(()=>{const t=b();m.pageHistoryStack[t]=[],m.activePage=t}));const M=new class{constructor(t){f(this,"canvas"),f(this,"className","Circle"),f(this,"id"),f(this,"isDrawing",!1),f(this,"startX",0),f(this,"startY",0),f(this,"currentCb"),f(this,"currentEllipse"),f(this,"disable",(()=>{this.isDrawing=!1})),f(this,"onMouseUp",(t=>{y(this.canvas),this.disable(),this.reset(),this.destroy()})),f(this,"onMouseMove",(t=>{if(!this.isEnable())return;let e=this.canvas.getPointer(t.e),s=this.currentEllipse;s&&s instanceof fabric.Ellipse&&(s.stroke="red",s.strokeWidth=5,s.fill="red",this.startX>e.x&&s.set({left:Math.abs(e.x)}),this.startY>e.y&&s.set({top:Math.abs(e.y)}),s.set({rx:Math.abs(this.startX-e.x)/2}),s.set({ry:Math.abs(this.startY-e.y)/2}),s.setCoords()),this.canvas.renderAll()})),f(this,"onMouseDown",(t=>{console.log("on mouse down canvas"),this.enable();let e=this.canvas.getPointer(t.e);this.startX=e.x,this.startY=e.y;const s=b();let a=new fabric.Ellipse({id:s,top:this.startY,left:this.startX,rx:0,ry:0});this.canvas.add(a),this.currentEllipse=a,m.objectsPerPage[m.activePage]={[s]:{id:s,object:a}}})),this.canvas=t,this.id=b()}init(t){this.canvas.on("mouse:down",this.onMouseDown),this.canvas.on("mouse:move",this.onMouseMove),this.canvas.on("mouse:up",this.onMouseUp),this.canvas.on("object:moving",this.disable),this.currentCb=t}destroy(){this.canvas.off("mouse:down",this.onMouseDown),this.canvas.off("mouse:move",this.onMouseMove),this.canvas.off("mouse:up",this.onMouseUp),this.canvas.off("object:moving",this.disable),this.currentEllipse=void 0,this.currentCb&&this.currentCb()}isEnable(){return this.isDrawing}enable(){this.isDrawing=!0}reset(){this.startX=0,this.startY=0}}(k),C=new class{constructor(t){f(this,"canvas"),f(this,"className","Circle"),f(this,"id"),f(this,"isDrawing",!1),f(this,"startX",0),f(this,"startY",0),f(this,"originalStar"),f(this,"currentCb"),f(this,"currentShape"),f(this,"disable",(()=>{this.isDrawing=!1})),f(this,"getNewPath",((t,e)=>(this.originalStar.path||[]).map((s=>[s[0],s[1]*t,s[2]*e])))),f(this,"onMouseUp",(t=>{y(this.canvas),this.disable(),this.reset(),this.destroy()})),f(this,"onMouseMove",(t=>{if(!this.isEnable())return;let e=this.canvas.getPointer(t.e),s=this.currentShape;if(s&&s instanceof fabric.Path){const t=this.originalStar.width||22,a=Math.abs(this.startX-e.x)/t,i=Math.abs(this.startY-e.y)/t,r=a*t,n=i*t;this.startX>e.x&&s.set({left:Math.abs(e.x)}),this.startY>e.y&&s.set({top:Math.abs(e.y)}),s.set({strokeWidth:(this.originalStar.strokeWidth||1)*(a+i)/2,path:this.getNewPath(a,i),width:r,height:n,pathOffset:{x:a*this.originalStar.pathOffset.x,y:i*this.originalStar.pathOffset.y}}),s.setCoords()}this.canvas.renderAll()})),f(this,"onMouseDown",(t=>{console.log("on mouse down canvas");let e=this.canvas.getPointer(t.e);this.startX=e.x,this.startY=e.y;const s=b();this.canvas.selection=!1,fabric.loadSVGFromURL("https://willofindie.com/vanilla-ts-fabricjs/assets/star.0eed8a5b.svg",(t=>{const e=t[0],a=S();e.set({id:s,shape:"star",top:this.startY,left:this.startX,fill:a[0],stroke:a[1],strokeWidth:.5,scaleX:1,scaleY:1,objectCaching:!1}),this.originalStar=((t,e)=>{for(var s in e||(e={}))u.call(e,s)&&p(t,s,e[s]);if(g)for(var s of g(e))v.call(e,s)&&p(t,s,e[s]);return t})({},e),e.path=this.getNewPath(0,0),this.canvas.add(e),this.currentShape=e,m.objectsPerPage[m.activePage]={[s]:{id:s,object:e}},this.enable()}))})),this.canvas=t,this.id=b()}init(t){this.canvas.on("mouse:down",this.onMouseDown),this.canvas.on("mouse:move",this.onMouseMove),this.canvas.on("mouse:up",this.onMouseUp),this.canvas.on("object:moving",this.disable),this.currentCb=t}destroy(){this.canvas.off("mouse:down",this.onMouseDown),this.canvas.off("mouse:move",this.onMouseMove),this.canvas.off("mouse:up",this.onMouseUp),this.canvas.off("object:moving",this.disable),this.currentShape=void 0,this.canvas.selection=!0,this.currentCb&&this.currentCb()}isEnable(){return this.isDrawing}enable(){this.isDrawing=!0}reset(){this.startX=0,this.startY=0}}(k);null==(e=P.querySelector("#createCircle"))||e.addEventListener("click",(t=>{m.activePage?(t.target.textContent="Drawing Circle",M.init((()=>{t.target.textContent="Create Circle"}))):console.log("No Active Page ID set")})),k.on("object:modified",(()=>{y(k)})),null==(s=P.querySelector("#clearPage"))||s.addEventListener("click",(()=>{var t;m.activePage?(k.clear(),m.objectsPerPage[m.activePage]={},t=m.pageHistoryStack[m.activePage].pop(),m.activePage&&(m.pageHistoryStack[m.activePage]=t?[t]:[])):console.log("No Active Page ID set")})),null==(a=P.querySelector("#recreatePage"))||a.addEventListener("click",(()=>{m.activePage?m.pageHistoryStack[m.activePage].length>0&&k.loadFromJSON(m.pageHistoryStack[m.activePage][m.pageHistoryStack[m.activePage].length-1],((...t)=>{})):console.log("No Active Page ID set")})),k.on("selection:created",(function(t){t.target&&(m.activeObject=t.target)})),k.on("selection:updated",(function(t){t.target&&(m.activeObject=t.target)})),k.on("selection:cleared",(function(){m.activeObject=null})),P.addEventListener("click",(t=>{const e=S();if(m.activeObject)switch(t.target.id){case"changeFillColor":m.activeObject.set("fill",e[0]),y(k);break;case"changeStrokeColor":m.activeObject.set("stroke",e[1]),y(k)}else console.log("Nothing selected")})),null==(i=P.querySelector("#undo"))||i.addEventListener("click",(()=>{m.redoUpdateStack[m.activePage]=m.redoUpdateStack[m.activePage]||[];const t=m.pageHistoryStack[m.activePage],e=t.pop();if(e){const s=t[t.length-1];m.redoUpdateStack[m.activePage].push(e),s?k.loadFromJSON(s,(()=>{})):k.clear()}})),null==(r=P.querySelector("#redo"))||r.addEventListener("click",(()=>{const t=m.redoUpdateStack[m.activePage];if(t&&t.length>0){const e=m.pageHistoryStack[m.activePage],s=t.pop();s&&(e.push(s),k.loadFromJSON(s,(()=>{})))}}));const D="rerender",E="rerender start",j="rerender end",x=(()=>{const t=s=>{null!==e.rafId?(e.rafId=requestAnimationFrame(t),s-e.timestamp>1e3/15&&(performance.mark(E),e.timestamp=s,k.requestRenderAll(),performance.mark(j),performance.measure(D,E,j))):e.timestamp=0},e={timestamp:0,rafId:null,start(){e.rafId=requestAnimationFrame((s=>{e.timestamp=s,t(e.timestamp)}))},end(){e.rafId&&cancelAnimationFrame(e.rafId),e.rafId=null,e.timestamp=0}};return e})();x.start(),window.canvas=k,window.renderer=x,null==(n=P.querySelector("#drawingMode"))||n.addEventListener("click",(t=>{k.freeDrawingBrush=new fabric.PencilBrush(k),k.freeDrawingBrush.width=8,k.isDrawingMode=!k.isDrawingMode,t.target.textContent=k.isDrawingMode?"Exit Drawing Mode":"Drawing Mode"})),null==(o=P.querySelector("#addText"))||o.addEventListener("click",(t=>{const e=new fabric.IText("this is\na multiline\ntext\naligned right!",{textAlign:"right"});k.add(e)})),null==(c=P.querySelector("#alignCenter"))||c.addEventListener("click",(t=>{const e=k.getActiveObject();console.log("Selected Object Type: ",e.type),"i-text"===e.type&&e.set("textAlign","center")})),null==(l=P.querySelector("#addStar"))||l.addEventListener("click",(t=>{t.target.textContent="Drawing Star",C.init((()=>{t.target.textContent="Create Star"}))}));const O=t=>{y(k)};null==(h=P.querySelector("#eraser"))||h.addEventListener("click",(t=>{k.freeDrawingBrush=new fabric.EraserBrush(k),k.freeDrawingBrush.width=10,k.isDrawingMode=!k.isDrawingMode,k.isDrawingMode?(t.target.textContent="Erasing",k.on("erasing:end",O)):(t.target.textContent="Erase",k.off("erasing:end",O))}));
